import '../mixin.moor';

baseConversationItemCount:
SELECT Count(1)
FROM conversations conversation
         INNER JOIN users owner ON owner.user_id = conversation.owner_id
         LEFT JOIN circle_conversations circleConversation ON conversation.conversation_id = circleConversation.conversation_id
WHERE $where;

baseConversationItems AS ConversationItem:
SELECT conversation.conversation_id AS conversationId, conversation.icon_url AS groupIconUrl,
    conversation.category AS category, conversation.draft AS draft,
    conversation.name AS groupName, conversation.status AS status,
    conversation.last_read_message_id AS lastReadMessageId,
    conversation.unseen_message_count AS unseenMessageCount, conversation.owner_id AS ownerId,
    conversation.pin_time AS pinTime, conversation.mute_until AS muteUntil,
    owner.avatar_url AS avatarUrl, owner.full_name AS name, owner.is_verified AS ownerVerified,
    owner.identity_number AS ownerIdentityNumber, owner.mute_until AS ownerMuteUntil,
    owner.app_id AS appId,
    lastMessage.content AS content, lastMessage.category AS contentType,
    conversation.created_at AS createdAt, lastMessage.created_at AS lastMessageCreatedAt,
    lastMessage.media_url AS mediaUrl,
    lastMessage.user_id AS senderId, lastMessage.action AS actionName,
    lastMessage.status AS messageStatus,
    lastMessageSender.full_name AS senderFullName, snapshot.type AS SnapshotType,
    participant.full_name AS participantFullName, participant.user_id AS participantUserId,
    (SELECT COUNT(1)
     FROM message_mentions messageMention
     WHERE messageMention.conversation_id = conversation.conversation_id AND
         messageMention.has_read = 0) as mentionCount,
    owner.relationship AS relationship
FROM conversations conversation
         INNER JOIN users owner ON owner.user_id = conversation.owner_id
         LEFT JOIN circle_conversations circleConversation ON conversation.conversation_id = circleConversation.conversation_id
         LEFT JOIN messages lastMessage ON conversation.last_message_id = lastMessage.message_id
         LEFT JOIN users lastMessageSender ON lastMessageSender.user_id = lastMessage.user_id
         LEFT JOIN snapshots snapshot ON snapshot.snapshot_id = lastMessage.snapshot_id
         LEFT JOIN users participant ON participant.user_id = lastMessage.participant_id
WHERE $where
ORDER BY $order
LIMIT $limit;

baseUnseenMessageCount:
SELECT SUM(unseen_message_count) FROM conversations conversation
  INNER JOIN users owner ON owner.user_id = conversation.owner_id
  LEFT JOIN circle_conversations circleConversation ON conversation.conversation_id = circleConversation.conversation_id
WHERE $where
LIMIT 1;

fuzzySearchConversation AS SearchConversationItem:
SELECT c.conversation_id AS conversationId, c.icon_url AS groupIconUrl, c.category AS category,
    c.name AS groupName,
    ou.identity_number AS ownerIdentityNumber, c.owner_id AS userId, ou.full_name AS fullName,
    ou.avatar_url AS avatarUrl,
    ou.is_verified AS isVerified, ou.app_id AS appId
FROM conversations c
         INNER JOIN users ou ON ou.user_id = c.owner_id
         LEFT JOIN messages m ON c.last_message_id = m.message_id
WHERE (c.category = 'GROUP' AND c.name LIKE '%' || :query || '%' ESCAPE '\') OR
    (c.category = 'CONTACT' AND ou.relationship != 'FRIEND'
        AND (ou.full_name LIKE '%' || :query || '%' ESCAPE '\'
            OR ou.identity_number like '%' || :query || '%' ESCAPE '\'))
ORDER BY (c.category = 'GROUP' AND c.name = :query COLLATE NOCASE)
    OR (c.category = 'CONTACT' AND ou.relationship != 'FRIEND'
        AND (ou.full_name = :query COLLATE NOCASE
            OR ou.identity_number = :query COLLATE NOCASE)) DESC,
    c.pin_time DESC,
    m.created_at DESC;

conversationParticipantsCount:
SELECT count(1) FROM participants WHERE conversation_id = :conversationId;

conversationStorageUsage AS ConversationStorageUsage:
SELECT c.conversation_id, c.owner_id, c.category, c.icon_url, c.name, u.identity_number,
    u.full_name, u.avatar_url, u.is_verified
FROM conversations c
         INNER JOIN users u ON u.user_id = c.owner_id
WHERE c.category IS NOT NULL;
